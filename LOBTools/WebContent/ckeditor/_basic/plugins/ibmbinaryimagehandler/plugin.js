CKEDITOR.plugins.add("ibmbinaryimagehandler",{lang:"ar,ca,cs,da,de,el,en,es,fi,fr,he,hr,hu,it,iw,ja,kk,ko,nb,nl,no,pl,pt,pt-br,ro,ru,sk,sl,sv,th,tr,uk,zh,zh-cn,zh-tw",init:function(d){var s=/<img[^>]*>/i;if((/\S/.test(d.config.ibmBinaryImageUploadUrl)||d.config.ibmPublishBinaryData)&&!d.config.ibmFilterPastedDataUriImage){var k=document.createElement("iframe");k.style.display="none";document.body.appendChild(k);var l=function(b){if(b.type.match("image.*")){var a=new FileReader;a.onload=function(){_html=
a.result;null!=_html&&d.fire("paste",{size:b.size,type:b.type,name:b.name,dataValue:'<img src="'+_html+'">'})};a.readAsDataURL(b)}},n=CKEDITOR.tools.addFunction(function(b){if(b){for(var a=0;a<b.length;a++){var c=b[a],g=c.url;if(c=d.document.getById(c.id))c.setAttribute("src",g),c.setAttribute("data-cke-saved-src",g)}d.fire("updateSnapshot")}},this),o=CKEDITOR.tools.addFunction(function(b){if(b){for(var a=0;a<b.length;a++){var c=d.document.getById(b[a]);c&&c.remove()}d.fire("updateSnapshot")}},this);
d.on("destroy",function(){document.body.removeChild(k)});d.on("paste",function(b){var a=/<img[^>]+src=["']{1}(data:image\/(?:(?!["'])[\w\W])*)["']{1}[^>]*[\/]?>/gi,c=/src=["']data:image\/[^('|")]*["']/i,g=b.data.dataValue,t=CKEDITOR.env.ie?k.contentWindow.document:k.contentDocument;if(a.test(g)){var j=(new Date).getTime(),e={};if(d.config.ibmBinaryImageUploadUrl){var h=document.createElement("form");h.enctype="multipart/form-data";h.method="POST";e.CKEditor=d.name;e.CKEditorFuncNum=n;e.CKEditorDeleteFuncNum=
o;e.Timestamp=j;e.idMapping=[]}for(var a=g.match(a),l=[],i=0;i<a.length;i++){var m=j+"_"+i,p=a[i].match(c),g=g.replace(a[i],a[i].replace("<img",'<img id="'+m+'"'));if(d.config.ibmPublishBinaryData){var f={};f.data=p;if(b.data.name&&(f.name=b.data.name,b.data.size&&(f.size=b.data.size),b.data.type))f.type=b.data.type;f.id=m}else{var q="imageUri"+i;e.idMapping.push('"'+q+'":"'+m+'"');h.innerHTML+='<input type="text" name="'+q+'" value='+p+">"}l.push(f)}if(d.config.ibmPublishBinaryData)d.config.ibmPublishBinaryData(n,
o,d.name,l);else{c=h;j=d.config.ibmBinaryImageUploadUrl;f=[];if(e){for(var r in e)f.push(r+"="+encodeURIComponent(e[r]));e=j+(-1!=j.indexOf("?")?"&":"?")+f.join("&")}else e=j;c.action=e;t.body.appendChild(h);h.submit()}b.data.dataValue=g}});d.on("contentDom",function(b){if(CKEDITOR.env.webkit)d.document.on("paste",function(a){var c=a.data.$.clipboardData.items;if(c)for(var b=0;b<c.length&&!(-1!==c[b].type.indexOf("text/rtf")||-1!==c[b].type.indexOf("application/rtf")||-1!==c[b].type.indexOf("application/x-rtf"));b++)if(-1!==
c[b].type.indexOf("image")){var d=c[b].getAsFile();a.data.$.preventDefault();l(d)}});b.editor.document.on("drop",function(a){var c=CKEDITOR.env.ie?"url":"text/html",c=CKEDITOR.env.ie?'<img src="'+a.data.$.dataTransfer.getData(c)+'">':a.data.$.dataTransfer.getData(c);CKEDITOR.env.mac&&(c=/\S/.test(a.data.$.dataTransfer.getData("url"))?'<img src="'+a.data.$.dataTransfer.getData("url")+'">':a.data.$.dataTransfer.getData("text/html"));var b=/<img[^>]+src=["']{1}(data:image\/(?:(?!["'])[\w\W])*)["']{1}[^>]*[\/]?>/gi;
if(s.test(c)&&b.test(c))a.data.$.preventDefault(),d.fire("paste",{dataValue:c});else if(0<a.data.$.dataTransfer.files.length){a.data.$.preventDefault();a=a.data.$.dataTransfer.files;for(c=0;c<a.length;c++)a[c].type.match("image.*")&&l(a[c])}})})}}});