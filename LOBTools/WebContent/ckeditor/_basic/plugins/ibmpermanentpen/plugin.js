(function(){function m(a,b,c,g,e){if("string"==typeof a&&b&&(g||e))0<a.length&&(a+=" "),a+=b+":"+(c&&g?g:e)+";";return a}function n(a){var b=a.getSelection(),b=b&&b.getStartElement();color=(b=(b=a.elementPath(b))&&b.block||b&&b.blockLimit||a.document&&a.document.getBody())&&b.getComputedStyle("color")||"#222";size=b&&b.getComputedStyle("font-size")||"12px";bgcolor=b&&b.getComputedStyle("background-color")||"#fff";font=b&&b.getComputedStyle("font-family")||"Arial, Helvetica, sans-serif";var b={"class":"ibmpermanentpen",
style:""},c;c=m("","color",a.config.textColor,a.config.textColor,color);c=m(c,"background-color",a.config.bgColor,a.config.bgColor,bgcolor);c=m(c,"font-family",a.config.fontName,a.config.fontName,font);c=m(c,"font-size",a.config.fontSize,a.config.fontSize,size);b.style=c;return new CKEDITOR.style({element:"span",attributes:b})}function l(a,b,c,g){if(b.type===CKEDITOR.NODE_ELEMENT&&b.getName){var e;switch(b.getName()){case "span":if(b.hasClass("ibmpermanentpen")&&b.getAttribute("style")){var d=function(a){for(var b=
{},a=a.split(";"),c=0;c<a.length;c++){var d=a[c].split(":");2==d.length&&(b[d[0].replace(/\s/g,"")]=d[1].replace(/\s/g,""))}return b};e=d(CKEDITOR.tools.convertRgbToHex(b.getAttribute("style")));var f=CKEDITOR.style.getStyleText(c);CKEDITOR.env.ie&&9>CKEDITOR.env.version&&(f=""!==f?f:c._.definition._ST);d=d(CKEDITOR.tools.convertRgbToHex(f));if(d["background-color"]!==e["background-color"]||d.color!==e.color||d["font-family"]!==e["font-family"]||d["font-size"]!==e["font-size"]){a=a.splitElement(b);
e=g.createRange();if(a)e.setStartBefore(a);else return b;g.getSelection().selectRanges([e]);return l(e,a.getParent(),c,g)}}return b;case "em":case "strong":case "i":case "u":case "s":case "b":a=a.splitElement(b);e=g.createRange();if(a)e.setStartBefore(a);else return b;g.getSelection().selectRanges([e]);return l(e,a.getParent(),c,g);default:return b}}}var o={readOnly:1,preserveState:!0,editorFocus:!0,allowedContent:"span[!class]{background-color, color, font-family, font-size}; strong b em i s u;",
requiredContent:["span[class]{color, font-family, font-size}","span(ibmpermanentpen){color, font-family, font-size}"],exec:function(a){this.toggleState();this.refresh(a)},refresh:function(a){if(a.document)if(this.state==CKEDITOR.TRISTATE_ON){if(a.config.displayPermamentPenMenu=!0,!a.config.styleDefined){if(a.config.ibmPermanentpenCookies){var b;a:{var c;b:{c=document.cookie.split(";");for(var g=0;g<c.length;g++){for(var e=c[g];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf("ibmpermanentpen=")){c=
e.substring(16,e.length);break b}}c=null}if(c){var d,f;try{d=window.atob?JSON.parse(window.atob(c)):JSON.parse(decodeURIComponent(c));f={};f.textColor=d.textColor;f.bgColor=d.bgColor;f.fontName=d.fontName;f.fontSize=d.fontSize;f.boldValue=d.boldValue;f.italicValue=d.italicValue;f.underlineValue=d.underlineValue;f.strikethroughValue=d.strikethroughValue;b=f;break a}catch(h){}}b=null}a.config.textColor=b&&b.textColor?b.textColor:"";a.config.bgColor=b&&b.bgColor?b.bgColor:"";a.config.fontName=b&&b.fontName?
b.fontName:"";a.config.fontSize=b&&b.fontSize?b.fontSize:"";a.config.boldValue=b&&b.boldValue?b.boldValue:!1;a.config.italicValue=b&&b.italicValue?b.italicValue:!1;a.config.underlineValue=b&&b.underlineValue?b.underlineValue:!1;a.config.strikethroughValue=b&&b.strikethroughValue?b.strikethroughValue:!1}else a.config.ibmPermanentPenStyle?(a.config.textColor=a.config.ibmPermanentPenStyle.textColor?a.config.ibmPermanentPenStyle.textColor:"",a.config.bgColor=a.config.ibmPermanentPenStyle.bgColor?a.config.ibmPermanentPenStyle.bgColor:
"",a.config.fontName=a.config.ibmPermanentPenStyle.fontName?a.config.ibmPermanentPenStyle.fontName:"",a.config.fontSize=a.config.ibmPermanentPenStyle.fontSize?a.config.ibmPermanentPenStyle.fontSize:"",a.config.boldValue=a.config.ibmPermanentPenStyle.boldValue?a.config.ibmPermanentPenStyle.boldValue:!1,a.config.italicValue=a.config.ibmPermanentPenStyle.italicValue?a.config.ibmPermanentPenStyle.italicValue:!1,a.config.underlineValue=a.config.ibmPermanentPenStyle.underlineValue?a.config.ibmPermanentPenStyle.underlineValue:
!1,a.config.strikethroughValue=a.config.ibmPermanentPenStyle.strikethroughValue?a.config.ibmPermanentPenStyle.strikethroughValue:!1):(a.config.textColor="",a.config.bgColor="",a.config.fontName="",a.config.fontSize="",a.config.boldValue="",a.config.italicValue=!1,a.config.underlineValue=!1,a.config.strikethroughValue=!1);!a.config.textColor&&(!a.config.bgColor&&!a.config.fontName&&!a.config.fontSize&&!a.config.boldValue&&!a.config.italicValue&&!a.config.underlineValue&&!a.config.strikethroughValue)&&
(a.config.textColor="#ff0000",a.config.fontName="Arial, Helvetica, sans-serif",a.config.fontSize="12px",a.config.boldValue=!0)}}else{a.config.displayPermamentPenMenu=!1;b=a.getSelection().getRanges()[0];d=b.endContainer;f=n(a);d.getParents();a.fire("lockSnapshot");var k=new CKEDITOR.dom.element("span");f.applyToObject(k,a);for(var i=d;i&&i.getParent();){var j=i.getParent();if(j){if(j.getName&&"span"==j.getName()&&(k.getAttribute("style")&&(g=CKEDITOR.tools.convertRgbToHex(k.getAttribute("style"))),
j.getAttribute("style")&&(e=CKEDITOR.tools.convertRgbToHex(j.getAttribute("style"))),g===e)){c=j;break}i=j}}if(c&&(d.type==CKEDITOR.NODE_TEXT?l(b,d.getParent(),f,a):l(b,d,f,a),c.getAttribute("class")&&0>c.getAttribute("class").indexOf("ibmpermanentpen")&&(b=a.getSelection().getRanges()[0],c=b.splitElement(c))))g=a.createRange(),g.setStartBefore(c),g.setEndBefore(c),g.select();a.fire("unlockSnapshot")}}};CKEDITOR.plugins.add("ibmpermanentpen",{lang:"ar,ca,cs,da,de,el,en,es,fi,fr,he,hr,hu,it,iw,ja,kk,ko,nb,nl,no,pl,pt,pt-br,ro,ru,sk,sl,sv,th,tr,uk,zh,zh-cn,zh-tw",
icons:"ibmpermanentpen",requires:["colordialog","basicstyles","dialog"],init:function(a){a.addCommand("ibmpermanentpen",o);a.addMenuItems&&(a.addMenuItems({pen:{label:a.lang.ibmpermanentpen.title,icon:"ibmpermanentpen",command:"pen",group:"clipboard",order:16}}),a.contextMenu.addListener(function(){return a.getCommand("ibmpermanentpen").state==CKEDITOR.TRISTATE_ON?{pen:CKEDITOR.TRISTATE_OFF}:null}));a.ui.addButton("IbmPermanentPen",{label:a.lang.ibmpermanentpen.pen,command:"ibmpermanentpen"});CKEDITOR.dialog.add("permanentpen",
this.path+"dialogs/permanentpen.js");a.addCommand("pen",new CKEDITOR.dialogCommand("permanentpen"));a.config.blockedKeystrokes.push(CKEDITOR.CTRL+CKEDITOR.ALT+84);a.setKeystroke(CKEDITOR.CTRL+CKEDITOR.ALT+84,"ibmpermanentpen");a.on("blur",function(){a.getCommand("ibmpermanentpen").setState(CKEDITOR.TRISTATE_OFF);a.config.styleDefined=false});a.on("key",function(b){if(a.getCommand("ibmpermanentpen").state==CKEDITOR.TRISTATE_ON&&b.data&&!b.data.domEvent.$.ctrlKey&&!b.data.domEvent.$.altKey){var c=n(a),
g=a.getSelection().getRanges()[0],b=g.endContainer,e=b.getParent(),d=b.getParents(),b=false,f;f=(a.config.boldValue&&a.getCommand("bold").state!=1||!a.config.boldValue&&a.getCommand("bold").state!=2)&&a.getCommand("bold").state!=0||(a.config.underlineValue&&a.getCommand("underline").state!=1||!a.config.underlineValue&&a.getCommand("underline").state!=2)&&a.getCommand("underline").state!=0||(a.config.strikethroughValue&&a.getCommand("strike").state!=1||!a.config.strikethroughValue&&a.getCommand("strike").state!=
2)&&a.getCommand("strike").state!=0||(a.config.italicValue&&a.getCommand("italic").state!=1||!a.config.italicValue&&a.getCommand("italic").state!=2)&&a.getCommand("italic").state!=0?false:true;if(c){for(var h in d)if(d[h].getName&&d[h].getName()=="span"&&d[h].getAttribute("class")=="ibmpermanentpen"){var k=new CKEDITOR.dom.element("span");c.applyToObject(k,a);var i,j;k.getAttribute("style")&&(i=CKEDITOR.tools.convertRgbToHex(k.getAttribute("style")));d[h].getAttribute("style")&&(j=CKEDITOR.tools.convertRgbToHex(d[h].getAttribute("style")));
if(i===j){b=true;break}}(!b||!f)&&l(g,e,c,a);if(!f||!b){a.fire("saveSnapshot");a.applyStyle(c);a.fire("saveSnapshot");if(a.config.ibmPermanentpenCookies){h={};h.textColor=a.config.textColor;h.bgColor=a.config.bgColor;h.fontName=a.config.fontName;h.fontSize=a.config.fontSize;h.boldValue=a.config.boldValue;h.italicValue=a.config.italicValue;h.underlineValue=a.config.underlineValue;h.strikethroughValue=a.config.strikethroughValue;i=new Date;i.setFullYear(i.getFullYear()+1);i=a.config.ibmCookieMaxAge?
a.config.ibmCookieMaxAge:i.toGMTString();h=window.btoa?window.btoa(JSON.stringify(h)):encodeURIComponent(JSON.stringify(h));document.cookie="ibmpermanentpen="+h+(a.config.baseDomain?";domain="+a.config.ibmBaseDomain:"")+";expires="+i+";path=/;"}}if(!f||!b){a.fire("lockSnapshot");(a.config.boldValue&&a.getCommand("bold").state!=1||!a.config.boldValue&&a.getCommand("bold").state!=2)&&a.execCommand("bold");(a.config.underlineValue&&a.getCommand("underline").state!=1||!a.config.underlineValue&&a.getCommand("underline").state!=
2)&&a.execCommand("underline");(a.config.strikethroughValue&&a.getCommand("strike").state!=1||!a.config.strikethroughValue&&a.getCommand("strike").state!=2)&&a.execCommand("strike");(a.config.italicValue&&a.getCommand("italic").state!=1||!a.config.italicValue&&a.getCommand("italic").state!=2)&&a.execCommand("italic");a.fire("unlockSnapshot")}}}},null,null,1)}})})();